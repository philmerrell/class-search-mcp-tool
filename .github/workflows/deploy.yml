name: Build and Deploy MCP Lambda

on:
  push:
    branches:
      - main
    paths:
      - 'mcp-tool/**'
      - 'infrastructure/**'
      - 'scripts/**'
      - '.github/workflows/deploy.yml'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag'
        required: false
        default: 'latest'
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.CDK_AWS_REGION || 'us-west-2' }}
  NODE_VERSION: '20'
  DEFAULT_ENVIRONMENT: dev

  # CDK Configuration - from GitHub Variables
  CDK_PROJECT_PREFIX: ${{ vars.CDK_PROJECT_PREFIX || 'mcp-docker-lambda' }}
  CDK_AWS_REGION: ${{ vars.CDK_AWS_REGION || 'us-west-2' }}
  CDK_LAMBDA_MEMORY_MB: ${{ vars.CDK_LAMBDA_MEMORY_MB || '512' }}
  CDK_LAMBDA_TIMEOUT_SECONDS: ${{ vars.CDK_LAMBDA_TIMEOUT_SECONDS || '30' }}

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ============================================================================
  # Build Docker Image
  # ============================================================================
  build-docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}
    outputs:
      image_tag: ${{ steps.set-tag.outputs.image_tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set image tag
        id: set-tag
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.image_tag }}" ]]; then
            TAG="${{ github.event.inputs.image_tag }}"
          else
            TAG="${{ github.sha }}"
          fi
          echo "image_tag=${TAG}" >> $GITHUB_OUTPUT
          echo "CDK_IMAGE_TAG=${TAG}" >> $GITHUB_ENV

      - name: Build Docker image
        env:
          CDK_IMAGE_TAG: ${{ steps.set-tag.outputs.image_tag }}
          EXPORT_TAR: "true"
        run: ./scripts/stack-mcp-lambda/build-docker.sh

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: "*.tar"
          retention-days: 1

  # ============================================================================
  # Synthesize CDK Templates
  # ============================================================================
  synth-cdk:
    name: Synthesize CDK
    runs-on: ubuntu-latest
    needs: [build-docker]
    environment: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: infrastructure/package-lock.json

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Get AWS Account ID
        id: aws-account
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=${ACCOUNT_ID}" >> $GITHUB_OUTPUT
          echo "CDK_AWS_ACCOUNT_ID=${ACCOUNT_ID}" >> $GITHUB_ENV

      - name: Install CDK dependencies
        run: ./scripts/stack-mcp-lambda/install.sh

      - name: Synthesize CDK stack
        env:
          CDK_IMAGE_TAG: ${{ needs.build-docker.outputs.image_tag }}
          CDK_AWS_ACCOUNT_ID: ${{ steps.aws-account.outputs.account_id }}
        run: ./scripts/stack-mcp-lambda/synth.sh

      - name: Upload CDK output artifact
        uses: actions/upload-artifact@v4
        with:
          name: cdk-out
          path: infrastructure/cdk.out
          retention-days: 7

  # ============================================================================
  # CDK Diff (PRs only)
  # ============================================================================
  diff-cdk:
    name: CDK Diff
    runs-on: ubuntu-latest
    needs: [build-docker, synth-cdk]
    if: github.event_name == 'pull_request'
    environment: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: infrastructure/package-lock.json

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Get AWS Account ID
        id: aws-account
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "CDK_AWS_ACCOUNT_ID=${ACCOUNT_ID}" >> $GITHUB_ENV

      - name: Install CDK dependencies
        run: ./scripts/stack-mcp-lambda/install.sh

      - name: Download CDK output artifact
        uses: actions/download-artifact@v4
        with:
          name: cdk-out
          path: infrastructure/cdk.out

      - name: Show CDK diff
        env:
          CDK_IMAGE_TAG: ${{ needs.build-docker.outputs.image_tag }}
        run: ./scripts/stack-mcp-lambda/diff.sh

  # ============================================================================
  # Push Docker Image to ECR
  # ============================================================================
  push-docker:
    name: Push to ECR
    runs-on: ubuntu-latest
    needs: [build-docker, synth-cdk]
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    environment: ${{ github.event.inputs.environment || 'dev' }}
    outputs:
      ecr_image_uri: ${{ steps.push.outputs.ecr_image_uri }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Get AWS Account ID
        id: aws-account
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=${ACCOUNT_ID}" >> $GITHUB_OUTPUT
          echo "CDK_AWS_ACCOUNT_ID=${ACCOUNT_ID}" >> $GITHUB_ENV

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: .

      - name: Push Docker image to ECR
        id: push
        env:
          CDK_IMAGE_TAG: ${{ needs.build-docker.outputs.image_tag }}
          CDK_AWS_ACCOUNT_ID: ${{ steps.aws-account.outputs.account_id }}
          LOAD_TAR: "${{ env.CDK_PROJECT_PREFIX }}-mcp-tool-${{ needs.build-docker.outputs.image_tag }}.tar"
        run: ./scripts/stack-mcp-lambda/push-docker.sh

  # ============================================================================
  # Deploy to AWS
  # ============================================================================
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    needs: [build-docker, synth-cdk, push-docker]
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    environment: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: infrastructure/package-lock.json

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          audience: sts.amazonaws.com

      - name: Get AWS Account ID
        id: aws-account
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          echo "account_id=${ACCOUNT_ID}" >> $GITHUB_OUTPUT
          echo "CDK_AWS_ACCOUNT_ID=${ACCOUNT_ID}" >> $GITHUB_ENV

      - name: Install CDK dependencies
        run: ./scripts/stack-mcp-lambda/install.sh

      - name: Download CDK output artifact
        uses: actions/download-artifact@v4
        with:
          name: cdk-out
          path: infrastructure/cdk.out

      - name: Deploy CDK stack
        id: deploy
        env:
          CDK_IMAGE_TAG: ${{ needs.build-docker.outputs.image_tag }}
          CDK_AWS_ACCOUNT_ID: ${{ steps.aws-account.outputs.account_id }}
        run: ./scripts/stack-mcp-lambda/deploy.sh

      - name: Generate deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.inputs.environment || env.DEFAULT_ENVIRONMENT }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | ${{ needs.build-docker.outputs.image_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ECR Image | ${{ needs.push-docker.outputs.ecr_image_uri }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | ${{ env.AWS_REGION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Timestamp | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |" >> $GITHUB_STEP_SUMMARY
          if [[ -n "${{ steps.deploy.outputs.function_url }}" ]]; then
            echo "| Function URL | ${{ steps.deploy.outputs.function_url }} |" >> $GITHUB_STEP_SUMMARY
          fi
